"use strict";const e=require("../../common/vendor.js"),o={data:()=>({WxOpenId:""}),methods:{async userLogin(){try{const t=await this.getWxCode(),a=await this.getWxOpneId(t);if(-1==a)return void e.index.showToast({title:"获取openid失败"+JSON.stringify(a),image:"/static/logo.png"});await this.checkUser(a)||await this.createUser(a);try{const o=await e.Ws.callFunction({name:"getUserInfo",data:{WxOpenId:a}});console.log("获取用户信息：",o.result.data);const t=o.result.data;getApp().globalData.WxOpenId=a,getApp().globalData.username=t.username,getApp().globalData.userAvater=t.userAvater,getApp().globalData.userTel=t.userTel}catch(o){console.error("获取用户信息失败：",o),e.index.showToast({title:"获取用户信息失败"+JSON.stringify(o),image:"/static/logo.png"})}e.index.reLaunch({url:"/pages/homepage/homepage",success(){e.index.$emit("LoginID",a),console.log("登录信息")}})}catch(t){console.error("userLogin() fail：",t),e.index.showToast({title:"登录异常，请重试"+JSON.stringify(t),image:"/static/logo.png"})}},async getWxCode(){const o=await e.index.login({provider:"weixin"});if(o.code)return console.log("用户code：",o.code),o.code;throw console.log("登录失败！"+o.errMsg),new Error("获取用户 code 失败")},async getWxOpneId(o){console.log("getWxOpneId，code is",o);const t=await e.Ws.callFunction({name:"getWxOpenId",data:{code:o}});return 0==t.result.code?(console.log("用户的 OpenID：",t.result.data.openId),t.result.data.openId):(console.log("获取openid失败,",t),-1)},checkUser:async o=>0!=(await e.Ws.callFunction({name:"checkUserById",data:{WxOpenId:o}})).result.code,async createUser(o){const t=await e.Ws.callFunction({name:"createUser",data:{WxOpenId:o}});if(0!==t.result.code)throw new Error("用户添加失败");console.log("数据库添加用户成功 res=",t)},userProfile(){e.index.getUserProfile({provider:"weixin",desc:"用于登录",success:o=>{console.log("登录成功，code:",o.rawData),console.log("userinfo:",o.userInfo),e.index.reLaunch({url:"/pages/homepage/homepage"})},fail:e=>{console.log("登录失败，code:",e)}})},test(){console.log("test",this.WxOpenId)}},onLoad(){console.log("onLoad")}};const t=e._export_sfc(o,[["render",function(o,t,a,n,s,r){return{a:e.o(((...e)=>r.userLogin&&r.userLogin(...e)))}}]]);wx.createPage(t);
